<!DOCTYPE html>
<html lang="en">

<head>
    <title>WarrantCanaryMonitor</title>
    <meta property="og:title" content="WarrantCanaryMonitor" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.11/semantic.min.css" integrity="sha256-g4+HzlttFiqgeuCnx3m308o0ahuBZ+0CRxaRWfSL0BU=" crossorigin="anonymous" />
    <link rel="stylesheet" type="text/html" href="/css/general.css">
    <meta http-equiv="content-type" content="text/html;charset=UTF-8">
    <script src="bower_components/web3/dist/web3.min.js" type="text/html"></script>

</head>

<body style="height: 100%;">
    <div class="ui fixed inverted menu" style="height: 55px;" id="menu">
        <div class="ui container">
            <a href="/" class="item">
                <i class="home icon"></i> Home
            </a>
            <a href="/about" class="item">
                <i class="help circle icon"></i> About
            </a>
            <a href="/canaries" class="item">
                <i class="protect icon"></i> Canaries
            </a>
        </div>
    </div>

    <!-- BODY CONTAINER -->
    <div class="ui body container" style="height: 100%;">
        {{ content }}
        <div class="row">
          <div>
            <h1 class="page-header">Check Canary:</h1>
            <form id="check_canary_status" method="post">
                <input type="text" name="canary_address" />
                <input type="submit" value="Check Status" />
            </form>
          </div>
          STATUS: <span id="canary_status"></span> <br />
          LAST PING: <span id="canary_ping"></span> <br />
        </div>
    </div>

    <!-- FOOTER -->
    <div class="ui inverted vertical footer segment" style="height: 55px;">
        <div class="ui container">
            <div class="ui horizontal inverted small divided link list">
                <div class="item"><div style="color:white"><a href="https://github.com/ethba-warrantcanary/">WarrantCanaryMonitor</a></div><br> Created by <a target="_blank" href="https://mycrypto.com">MyCrypto</a>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
    //let web3 = new Web3(new Web3.providers.HttpProvider("http://127.0.0.1:9545/"));
    let web3 = new Web3(new Web3.providers.HttpProvider("https://ropsten.infura.io/BvLrFkkpvJn7LSt3EUUz"));
    let account = '';
    let contractAddress = '0x2fc22f539f769486ba027ba7dbf2b8bdeea06c99';
    let abi = [{"constant":true,"inputs":[{"name":"_address","type":"address"}],"name":"getCanaryNameByAddress","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_name","type":"bytes32"}],"name":"initCanary","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"pingCanary","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[{"name":"_address","type":"address"}],"name":"getCanaryLastBlockPing","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_address","type":"address"}],"name":"isCanaryAlive","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"}];
    let contract = web3.eth.contract(abi).at(contractAddress);
    web3.eth.defaultAccount = account;

    // Get the initial account balance so it can be displayed.
    web3.eth.getAccounts(function(err, accs) {
        if (err != null) {
            alert("There was an error fetching your accounts.");
            return;
        }

        if (accs.length == 0) {
            console.log("No accounts found!");
            return;
        }

        accounts = accs;
        account = accounts[0];
        console.log("Account: "+ account);
        document.querySelector('form#check_canary_status input').value = account;
    });

    console.log(contract);

    var objCheckCanary = document.getElementById("check_canary_status");
    objCheckCanary.addEventListener('submit', (e) => {
        e.preventDefault();
        _0xaddress = document.querySelector('form#check_canary_status input').value;

        if(contract.isCanaryAlive(_0xaddress)) {
            document.getElementById("canary_status").innerText = "CANARY IS ALIVE";

            var lastblock = contract.getCanaryLastBlockPing(_0xaddress);
            document.getElementById("canary_status").innerText = lastblock;

        } else {
            document.getElementById("canary_status").innerText = "CANARY IS DEAD ALIVE";
        }
    });
</script>
</body>

</html>
